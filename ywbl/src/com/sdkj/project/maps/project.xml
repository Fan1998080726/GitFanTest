<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace ="project" > 

   	<typeAlias alias ="projectChild" type ="com.sdkj.project.vo.ProjectChildVo"/> 
   	<typeAlias alias ="project" type ="com.sdkj.project.vo.ProjectVo"/> 
   	<typeAlias alias ="projectFile" type ="com.sdkj.project.vo.ProjectFileVo"/> 
	<typeAlias alias ="contract" type ="com.sdkj.contract.vo.ContractVo"/> 
	<typeAlias alias ="changeApply" type ="com.sdkj.project.vo.ChangeApplyVo"/> 
	<typeAlias alias ="changeApplyFileVo" type ="com.sdkj.project.vo.ChangeApplyFileVo"/> 
	<typeAlias alias ="qualityWarningVo" type ="com.sdkj.project.vo.QualityWarningVo"/> 
	<typeAlias alias ="safeWarningVo" type ="com.sdkj.project.vo.SafeWarningVo"/> 
	
   	<select id ="queryProjectChildList" resultClass="projectChild" parameterClass ="int"  > 
    	select pc_id,pro_id,pc_name,pc_level,pc_pid as '_parentId',pc_describe,pc_is_child
 		from project_child where pro_id=#projectId#
   	</select > 
   	<select id ="getProjectChildCount" resultClass="int" parameterClass ="int"  > 
    	select count(*)
 		from project_child where pro_id=#projectId#
   	</select > 
   
   	<select id ="getProjectById" resultClass="project" parameterClass ="int"  > 
    	select pro_id,pro_name,pro_type,pro_invest,pro_assistants,
		(select sum(a.pp_measure) from progress_plan a,project_child b 
		where a. pc_id=b.pc_id and b.pro_id=#projectId#) pro_measure,
		pro_measure,pro_start_date,
		    	pro_end_date,pro_place,pro_manager,
		(select user_name from system_user_info where id=pro_manager) pro_manager_name,
		    	pro_state,pro_describe,pro_flag
 		from project where pro_id=#projectId#
   	</select >
   
   	<insert id="addProject" parameterClass="contract">
		insert into project(pro_id,pro_name,pro_invest,
		pro_start_date,pro_end_date,pro_place,pro_state,pro_flag)
		values (#c_id#,#c_name#,#c_invest#,
		#c_start_date#,#c_end_date#,#c_address#,4,7)
	</insert>
	
	<update id="updateProject" parameterClass="project">
		update project set
				pro_name=#pro_name#,
				pro_type=#pro_type#,
				pro_invest=#pro_invest#,
				
				pro_start_date=#pro_start_date#,
				pro_end_date=#pro_end_date#,
				pro_place=#pro_place#,
				pro_manager=#pro_manager#,
				pro_state=#pro_state#,
				pro_describe=#pro_describe#,
				pro_flag=#pro_flag#,
				pro_assistants=#pro_assistants#
		where pro_id=#pro_id#
	</update>
	
	<update id="addProChild" parameterClass="projectChild">
		 insert into project_child(pro_id,pc_name,pc_level,pc_pid,pc_is_child,pc_describe)
		 select pro_id,#pc_name#,pc_level+1,pc_id,0,#pc_describe# from project_child where pc_id=#_parentId#;
		
		 update project_child set pc_is_child=1 where pc_id=#_parentId#;
	</update>
	
	<update id="addProChildDw" parameterClass="projectChild">
		insert into project_child(pro_id,pc_name,pc_level,pc_pid,pc_is_child,pc_describe)
		values (#pro_id#,#pc_name#,1,0,0,#pc_describe#)
	</update>
	
	<update id="updateProChild" parameterClass="projectChild">
		update project_child set pc_name=#pc_name#,pc_describe=#pc_describe# where pc_id=#pc_id#
	</update>
	
	<delete id="delProjectChild" parameterClass="String">
		delete from project_child where pc_id=#pc_id#;		
	</delete>
	<select id="getProjectChildByPid" resultClass="int" parameterClass="String" >
		select count(*) from project_child where pc_pid=(select pc_pid from project_child where pc_id=#pc_id#)
	</select>
	<select id="getProjectChildById" parameterClass="String" resultClass="projectChild">
		select pc_id,pro_id,pc_name,pc_level,pc_pid as '_parentId',pc_describe from project_child where pc_id=#pc_id#
	</select>
	<update id="updatePrjectChildParent" parameterClass="String">
		select pc_pid into @pid from project_child where pc_id=#pc_id#;
		
		update project_child set pc_is_child=0 where pc_id=@pid
	</update>
	<insert id="addProjectFile" parameterClass="projectFile">
		insert into project_file(pro_id,pf_name,pf_url) values (#pro_id#,#pf_name#,#pf_url#)
	</insert>
	
	<select id="getFileByProject" resultClass="projectFile" parameterClass="int">
		select pf_id,pro_id,pf_name,pf_url from project_file where pro_id=#projectId#
	</select>
	
	<select id="getProListCountByRole" resultClass="int" parameterClass="String">
		select count(*) from ($value$) as ucount
	</select>
	
	<select id="getProListByRole" resultClass="project" parameterClass="String">
		$value$
	</select>
	
	<update id="delProjectFile" parameterClass="String">
		delete from project_file where pf_id in ($value$)
	</update>
	
	<select id="queryProgressByProChild" parameterClass="String" resultClass="int">
		select count(*) from progress_plan where pc_id=#pc_id#
	</select>
	
	<select id="queryCostByProChild" parameterClass="String" resultClass="int">
		select count(*) from cost_plan where pc_id=#pc_id#
	</select>
	
	<update id="changeProjectFlag" parameterClass="int">
		update project set pro_flag=8 where pro_id=#projectId#
	</update>
	
	<select id="getProjectByName" parameterClass="String" resultClass="int" >
		$value$
	</select>
	<select id="queryChangeApply" parameterClass="String" resultClass="changeApply">
		$value$
	</select>
	<insert id="addChangeApply" parameterClass="changeApply">
		insert into alter_apply(pro_id,aa_date,aa_user,aa_remark,aa_flag)
		values(
			#proId#,
			now(),
			#aaUser#,
			#aaRemark#,
			#aaFlag#
		)
		<selectKey resultClass="int" keyProperty="aaId">
		SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	<select id="queryChangeApplyStatus" resultClass="String" parameterClass="String">
		select count(*) 
		from alter_apply
		where aa_id in (#ids#)
			  and aa_flag = '29'
	</select>
	<update id="deleteChangeApply" parameterClass="String">
		delete from alter_apply where aa_id in (#ids#) and aa_flag = '29';
	</update>
	<insert id="addChangeApplyFile" parameterClass="java.util.Map">
		insert into 
		alter_apply_file(
			ca_id,
			caf_name,
			caf_url
		)values(
			#caId#,
			#cafName#,
			#cafUrl#
		)
	</insert>
	<delete id="deleteChangeApplyFile" parameterClass="String">
		delete from alter_apply_file
		where ca_id in (#ids#);
	</delete>
	<select id="queryChangeApplyDetail" parameterClass="String" resultClass="changeApply">
	select aa_id 'aaId',
		   pro_id 'proId',
		   cast(date_format(aa_date,'%Y-%m-%d %H:%i:%s') as char(19)) 'aaDate',
		   aa_user 'aaUser',
		   aa_remark 'aaRemark',
		   aa_flag 'aaFlag'
	from alter_apply
	where aa_id = #id#;
</select>
<select id="queryChangeApplyFileDetail" parameterClass="String" resultClass="changeApplyFileVo">
	select caf_id 'cafId',
		   ca_id 'caId',
		   caf_name 'cafName',
		   caf_url 'cafUrl'
	from alter_apply_file
	where ca_id = #id#;
</select>
<update id="updateChangeApplyStatus" parameterClass="String">
	update alter_apply 
	set aa_flag = 30
	where aa_id = #id#
</update>
<update id="updChangeApply" parameterClass="changeApply">
	update alter_apply
	set pro_id=#proId#,aa_date=now(),aa_user=#aaUser#,aa_remark=#aaRemark#,aa_flag=#aaFlag#
	where aa_id=#aaId#
</update>
<select id="queryCountNum" parameterClass="String" resultClass="java.util.HashMap">
$value$
<!-- 	SELECT
		count(*) 'count',
		t1.ms_type 'type'
	FROM
		message_send t1,
		message_receive t2
	WHERE
		t1.ms_id = t2.ms_id
	AND t2.mr_user = #id#
	AND t2.mr_del=0
	AND mr_read=1
	GROUP BY t1.ms_type -->
	
</select>
<select id="queryContractStatus" parameterClass="String" resultClass="String">
	select c_flag from contract where c_id = #id#
</select>
<select id="queryProjectStatus" parameterClass="String" resultClass="java.util.HashMap">
	select pro_flag 'status',pro_state 'state' from project where pro_id = #id#
</select>
<select  id="queryAllQualityWarning" resultClass="qualityWarningVo">
	SELECT
		t1.qc_id qcId,
		t1.qc_title qcTitle,
		t1.qc_type qcType,
		t1.qc_file_url qcFileUrl,
		t1.qc_file_name qcFileName,
		t1.qc_remark qcRemark,
		t1.qc_date qcDate,
		t2.pc_name pcName,
		t3.pro_name proName
	FROM
		quality_control t1,
		project_child t2,
		project t3
	WHERE
		t1.pc_id = t2.pc_id
	AND t2.pro_id = t3.pro_id
	AND t1.qc_type=28
	ORDER BY t1.qc_date desc
	LIMIT 0,4
</select>
<select  id="queryQualityWarningByUser" parameterClass="String" resultClass="qualityWarningVo">
	SELECT
		t1.qc_id qcId,
		t1.qc_title qcTitle,
		t1.qc_type qcType,
		t1.qc_file_url qcFileUrl,
		t1.qc_file_name qcFileName,
		t1.qc_remark qcRemark,
		t1.qc_date qcDate,
		t2.pc_name pcName,
		t3.pro_name proName
	FROM
		quality_control t1,
		project_child t2,
		project t3
	WHERE
		t1.pc_id = t2.pc_id
	AND t2.pro_id = t3.pro_id
	AND t3.pro_manager = #userId#
	AND t1.qc_type=28
	ORDER BY t1.qc_date desc
	LIMIT 0,4
</select>
<select  id="queryAllSafeWarning" resultClass="safeWarningVo">
	SELECT
		t1.sc_id scId,
		t1.sc_title scTitle,
		t1.sc_type scType,
		t1.sc_file_url scFileUrl,
		t1.sc_file_name scFileName,
		t1.sc_remark scRemark,
		t1.sc_date scDate,
		t2.pc_name pcName,
		t3.pro_name proName
	FROM
		safe_control t1,
		project_child t2,
		project t3
	WHERE
		t1.pc_id = t2.pc_id
	AND t2.pro_id = t3.pro_id
	AND t1.sc_type=28
	ORDER BY t1.sc_date desc
	LIMIT 0,4
</select>
<select id="querySafeWarningByUser" parameterClass="String" resultClass="safeWarningVo">
	SELECT
	t1.sc_id scId,
	t1.sc_title scTitle,
	t1.sc_type scType,
	t1.sc_file_url scFileUrl,
	t1.sc_file_name scFileName,
	t1.sc_remark scRemark,
	t1.sc_date scDate,
	t2.pc_name pcName,
	t3.pro_name proName
	FROM
		safe_control t1,
		project_child t2,
		project t3
	WHERE
		t1.pc_id = t2.pc_id
	AND t2.pro_id = t3.pro_id
	AND t3.pro_manager = #userId#
	AND t1.sc_type=28
	ORDER BY t1.sc_date desc
	LIMIT 0,4
</select>
<select id="queryChildCostActual" parameterClass="String" resultClass="int">
	SELECT
	count(*)
	FROM
		cost_plan t1,
		cost_actual t2
	WHERE
		t1.cp_id = t2.cp_id
	AND t1.pc_id = #id#;
</select>
<select id="queryChildProgressActual" parameterClass="String" resultClass="int">
	SELECT
	count(*)
	FROM
		progress_plan t1,
		progress_actual t2
	WHERE
		t1.pp_id = t2.pp_id
	AND t1.pc_id = #id#;
</select>
<delete id="deleteChildCostPlan" parameterClass="String">
	delete from cost_plan where pc_id = #id#
</delete>
<delete id="deleteChildProgressPlan" parameterClass="String">
	delete from progress_plan where pc_id = #id#
</delete>

<update id="cutPaste" parameterClass="java.util.HashMap">
	update project_child set pc_pid=#to_id#
	where pc_id=#from_id#;
	update project_child set pc_is_child=1 where pc_id=#to_id#
</update>

<select id="getChildCount" parameterClass="String" resultClass="int">
	select count(*) from project_child 
	where pc_pid=(select pc_pid from project_child where pc_id=#from_id#)
</select>

<update id="changeIsChild" parameterClass="String">
	SELECT pc_pid into @temp	FROM project_child WHERE pc_id =#from_id#;
	update project_child
	SET pc_is_child = 0
	WHERE	pc_id = @temp
</update>



<insert id="excelAddProChild" parameterClass="java.util.HashMap">
	insert into project_child(pro_id,pc_name,pc_level,pc_pid,pc_is_child,pc_describe)
	values(#proId#,#proName#,#level#,#pid#,#is_child#,#proDescribe#)
	
	<selectKey resultClass="int" keyProperty="pc_id">
	SELECT LAST_INSERT_ID()
	</selectKey>
</insert>
<!-- 20200305 
set name=#name#,cardnum=#cardnum#,personType=#personType#,prjType=#prjType#
		,phone=#phone#,corpname=#corpname#,lastupdatetime=#lastupdatetime#
		where id=#id#

-->
<insert id="excelInsertPrjPerson" parameterClass="java.util.HashMap">
	insert into prjcheckpersoninfo(id,name,cardnum,prjId,personType,personOne,phone,corpname,PrjType)
	values(#proId#,#personName#,#cardNum#,#prjId#,#personType#,#personOne#,#phone#,#corpName#,#PrjType#)
</insert>
<insert id="excelInsertPrjPersonCopy" parameterClass="java.util.HashMap">
	insert into prjcheckpersoninfoTemp(id,name,cardnum,prjId,personType,personOne,phone,corpname,PrjType)
	values(#proId#,#personName#,#cardNum#,#prjId#,#personType#,#personOne#,#phone#,#corpName#,#PrjType#)
</insert>
	<delete id="delexcelInsertPrjPersonCopy" parameterClass="String">
	$value$				
	</delete>
<update id="updateParentPro" parameterClass="int">
	update project_child set pc_is_child=1 where pro_id=#pid#
</update>

<insert id="excelAddProgress" parameterClass="java.util.HashMap">
	INSERT INTO progress_plan (pc_id,pp_start_date,pp_end_date,pp_measure)
	VALUES (#pcId#,#start#,#end#,#measure#)
</insert>

<insert id="excelAddCost" parameterClass="java.util.HashMap">
	INSERT INTO cost_plan (pc_id,cp_name,cp_type,cp_value)
	select #pcId#,#describe#,sc_id,#value# from system_code where sc_code='cost_type' and sc_name=#type#
</insert>

<select id="getUserForProject" resultClass="java.util.HashMap" parameterClass="java.lang.String">
	$value$
</select>

<select id="getUserInProject" resultClass="java.util.HashMap" parameterClass="java.lang.String">
	SELECT su.id,su.user_name FROM system_user_info su where su.id in ($value$)
</select>
</sqlMap> 
